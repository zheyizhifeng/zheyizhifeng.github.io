<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 5.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+Simplified+Chinese:300,300italic,400,400italic,700,700italic%7CCousine:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/green/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"zheyizhifeng.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/db.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="转载自掘金，原文链接 点这里查看  前言关于 Promise 原理解析的优秀文章已经屡见不鲜，但是笔者总 看了就会，一写就废，为了理一下 Promise 的编写思路，从零开始手写一波代码，同时也方便自己日后回顾。 Promise 的作用Promise 是 JavaScript 异步编程的一种流行解决方案，它的出现是为了解决 回调地狱 的问题，让使用者可以通过链式的写法去编写写异步代码，具体的用法笔">
<meta property="og:type" content="article">
<meta property="og:title" content="撸一个一个规范的 Promise">
<meta property="og:url" content="https://zheyizhifeng.github.io/2021/10/13/%E6%92%B8%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%E7%9A%84%20Promise/index.html">
<meta property="og:site_name" content="Lucida&#39;s Blog">
<meta property="og:description" content="转载自掘金，原文链接 点这里查看  前言关于 Promise 原理解析的优秀文章已经屡见不鲜，但是笔者总 看了就会，一写就废，为了理一下 Promise 的编写思路，从零开始手写一波代码，同时也方便自己日后回顾。 Promise 的作用Promise 是 JavaScript 异步编程的一种流行解决方案，它的出现是为了解决 回调地狱 的问题，让使用者可以通过链式的写法去编写写异步代码，具体的用法笔">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://camo.githubusercontent.com/e25d50e7473d8a8d90bd58b8e3b09c1ec301fd9b9ea25488c9c08e988ba5747a/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f36316566626332302d376362382d313165622d383566362d3666616337376330633962332e706e67">
<meta property="og:image" content="data:image/png;base64,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">
<meta property="og:image" content="data:image/png;base64,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">
<meta property="og:image" content="https://lh3.googleusercontent.com/proxy/lr0YKuQsKF2WSNXRArldIbv4tf6Gvleo-lnhF-IsNpzkHlefyjdou7u4cvcobhjmk2Up6BM75C5BK9H0yIOhDmSedgL9-iUBoHyuIcJzPLry5lEBwUtFlKE">
<meta property="og:image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/4/171dee30c47e8637~tplv-t2oaga2asx-watermark.awebp">
<meta property="og:image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/4/171dee469816c2f6~tplv-t2oaga2asx-watermark.awebp">
<meta property="article:published_time" content="2021-10-13T09:44:27.000Z">
<meta property="article:modified_time" content="2021-10-18T07:32:35.045Z">
<meta property="article:author" content="lucida">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Programming">
<meta property="article:tag" content="ES 6">
<meta property="article:tag" content="Promise">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://camo.githubusercontent.com/e25d50e7473d8a8d90bd58b8e3b09c1ec301fd9b9ea25488c9c08e988ba5747a/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f36316566626332302d376362382d313165622d383566362d3666616337376330633962332e706e67">


<link rel="canonical" href="https://zheyizhifeng.github.io/2021/10/13/%E6%92%B8%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%E7%9A%84%20Promise/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zheyizhifeng.github.io/2021/10/13/%E6%92%B8%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%E7%9A%84%20Promise/","path":"2021/10/13/撸一个规范的 Promise/","title":"撸一个一个规范的 Promise"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>撸一个一个规范的 Promise | Lucida's Blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Lucida's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Stay Hungry, Stay Foolish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">51</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">21</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">31</span></a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">Promise 的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BE%E5%89%8D%E7%9F%A5%E8%AF%86"><span class="nav-number">3.</span> <span class="nav-text">课前知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">观察者模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6"><span class="nav-number">3.2.</span> <span class="nav-text">事件循环机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Promises-A-%E8%A7%84%E8%8C%83"><span class="nav-number">3.3.</span> <span class="nav-text">Promises&#x2F;A+ 规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="nav-number">4.</span> <span class="nav-text">Promise 核心知识点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#executor"><span class="nav-number">4.1.</span> <span class="nav-text">executor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E4%B8%AA%E7%8A%B6%E6%80%81"><span class="nav-number">4.2.</span> <span class="nav-text">三个状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#then"><span class="nav-number">4.3.</span> <span class="nav-text">then</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%86%99-Promise-%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">手写 Promise 大致流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#executor-%E4%B8%8E%E4%B8%89%E4%B8%AA%E7%8A%B6%E6%80%81"><span class="nav-number">5.1.</span> <span class="nav-text">executor 与三个状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#then-%E6%96%B9%E6%B3%95"><span class="nav-number">5.2.</span> <span class="nav-text">then 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E5%B9%B6%E5%A4%84%E7%90%86-then-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">5.3.</span> <span class="nav-text">链式调用并处理 then 返回值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E7%89%88%EF%BC%88%E4%BB%8E%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90%E5%BC%80%E5%A7%8B%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">第一版（从一个简单例子开始）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A5%E4%B8%AA-%F0%9F%8C%B0"><span class="nav-number">6.1.</span> <span class="nav-text">来个 🌰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.2.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="nav-number">6.3.</span> <span class="nav-text">存在问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%89%88%EF%BC%88%E5%AE%9E%E7%8E%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">第二版（实现链式调用）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E4%B8%8A%E7%8A%B6%E6%80%81"><span class="nav-number">7.1.</span> <span class="nav-text">加上状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E5%96%84-then-%E5%87%BD%E6%95%B0"><span class="nav-number">7.2.</span> <span class="nav-text">完善 then 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#then-%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%AF%B4%E6%98%8E"><span class="nav-number">7.2.1.</span> <span class="nav-text">then 函数的一些说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-number">7.2.2.</span> <span class="nav-text">支持链式调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#then-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">7.2.3.</span> <span class="nav-text">then 返回值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E9%80%A0%E4%BB%A3%E7%A0%81"><span class="nav-number">7.2.4.</span> <span class="nav-text">改造代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98-1"><span class="nav-number">7.3.</span> <span class="nav-text">存在问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E7%89%88%EF%BC%88%E5%BC%82%E6%AD%A5%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">第三版（异步链式调用）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF"><span class="nav-number">8.1.</span> <span class="nav-text">思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%B4%E6%98%8E"><span class="nav-number">8.2.</span> <span class="nav-text">代码说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#resolvePromise"><span class="nav-number">8.2.1.</span> <span class="nav-text">resolvePromise</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#then-%E8%BF%94%E5%9B%9E%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="nav-number">8.2.2.</span> <span class="nav-text">then 返回值类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E8%8C%83-Promise"><span class="nav-number">9.</span> <span class="nav-text">规范 Promise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E8%8C%83-then%EF%BC%88%E8%A7%84%E8%8C%83-2-2%EF%BC%89"><span class="nav-number">9.1.</span> <span class="nav-text">规范 then（规范 2.2）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">9.1.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%BE%AE%E4%BB%BB%E5%8A%A1%E5%8C%85%E8%A3%B9"><span class="nav-number">9.1.2.</span> <span class="nav-text">使用微任务包裹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E8%8C%83-resolvePromise-%E5%87%BD%E6%95%B0%EF%BC%88%E8%A7%84%E8%8C%83-2-3%EF%BC%89"><span class="nav-number">9.2.</span> <span class="nav-text">规范 resolvePromise 函数（规范 2.3）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E5%BC%95%E7%94%A8"><span class="nav-number">9.2.1.</span> <span class="nav-text">重复引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#x-%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">9.2.2.</span> <span class="nav-text">x 的类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AA%E8%B0%83%E7%94%A8%E4%B8%80%E6%AC%A1"><span class="nav-number">9.2.3.</span> <span class="nav-text">只调用一次</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#x-%E4%B8%BA-Promise-%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.2.3.1.</span> <span class="nav-text">x 为 Promise 对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#x-%E4%B8%BA-thenable-%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.2.3.2.</span> <span class="nav-text">x 为 thenable 对象</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84-resolvePromise"><span class="nav-number">9.2.4.</span> <span class="nav-text">完整的 resolvePromise</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">9.3.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%E6%96%B9%E6%B3%95"><span class="nav-number">10.</span> <span class="nav-text">更多方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95"><span class="nav-number">10.1.</span> <span class="nav-text">实例方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-prototype-catch"><span class="nav-number">10.1.1.</span> <span class="nav-text">Promise.prototype.catch</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="nav-number">10.1.1.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A"><span class="nav-number">10.1.1.2.</span> <span class="nav-text">例子：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-prototype-finally"><span class="nav-number">10.1.2.</span> <span class="nav-text">Promise.prototype.finally</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="nav-number">10.1.2.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-number">10.1.2.2.</span> <span class="nav-text">例子</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="nav-number">10.2.</span> <span class="nav-text">静态方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-resolve"><span class="nav-number">10.2.1.</span> <span class="nav-text">Promise.resolve</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-4"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="nav-number">10.2.1.2.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-reject"><span class="nav-number">10.2.2.</span> <span class="nav-text">Promise.reject</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-5"><span class="nav-number">10.2.2.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="nav-number">10.2.2.2.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-all"><span class="nav-number">10.2.3.</span> <span class="nav-text">Promise.all</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-6"><span class="nav-number">10.2.3.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90-3"><span class="nav-number">10.2.3.2.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-race"><span class="nav-number">10.2.4.</span> <span class="nav-text">Promise.race</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-7"><span class="nav-number">10.2.4.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90-4"><span class="nav-number">10.2.4.2.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise-allSettled"><span class="nav-number">10.2.5.</span> <span class="nav-text">Promise.allSettled</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-8"><span class="nav-number">10.2.5.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90-5"><span class="nav-number">10.2.5.2.</span> <span class="nav-text">例子</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lucida"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">lucida</p>
  <div class="site-description" itemprop="description">文质彬彬，然后君子</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zheyizhifeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zheyizhifeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zheyizhifeng@126.com" title="E-Mail → mailto:zheyizhifeng@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/zheyizhifeng" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;zheyizhifeng" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/zheyizhifeng" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;zheyizhifeng" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/zheyizhifeng" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;zheyizhifeng" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="skype:zheyizhifeng?call|chat" title="Skype → skype:zheyizhifeng?call|chat" rel="noopener" target="_blank"><i class="fab fa-skype fa-fw"></i></a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/zheyizhifeng" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zheyizhifeng.github.io/2021/10/13/%E6%92%B8%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%E7%9A%84%20Promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="lucida">
      <meta itemprop="description" content="文质彬彬，然后君子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lucida's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          撸一个一个规范的 Promise
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-13 17:44:27" itemprop="dateCreated datePublished" datetime="2021-10-13T17:44:27+08:00">2021-10-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-10-18 15:32:35" itemprop="dateModified" datetime="2021-10-18T15:32:35+08:00">2021-10-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>转载自掘金，原文链接 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904147884441608?utm_source=gold_browser_extension?utm_source=gold_browser_extension">点这里查看</a></p>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>关于 <code>Promise</code> 原理解析的优秀文章已经屡见不鲜，但是笔者总 <strong>看了就会，一写就废</strong>，为了理一下 <code>Promise</code> 的编写思路，从零开始手写一波代码，同时也方便自己日后回顾。</p>
<h2 id="Promise-的作用"><a href="#Promise-的作用" class="headerlink" title="Promise 的作用"></a>Promise 的作用</h2><p><code>Promise</code> 是 <code>JavaScript</code> 异步编程的一种流行解决方案，它的出现是为了解决 <strong>回调地狱</strong> 的问题，让使用者可以通过链式的写法去编写写异步代码，具体的用法笔者就不介绍了，大家可以参考阮一峰老师的 <a href="https://link.juejin.cn/?target=http://es6.ruanyifeng.com/%23docs/promise">ES6 Promise教程</a>。</p>
<a id="more"></a>

<h2 id="课前知识"><a href="#课前知识" class="headerlink" title="课前知识"></a>课前知识</h2><h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h3><p>什么是观察者模式：</p>
<blockquote>
<p>观察者模式定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个目标对象，当这个目标对象的状态发生变化时，会通知所有观察者对象，使它们能够自动更新。</p>
</blockquote>
<p><code>Promise</code> 是基于 <strong>观察者的设计模式</strong> 实现的，<code>then</code> 函数要执行的函数会被塞入观察者数组中，当 <code>Promise</code> 状态变化的时候，就去执行观察组数组中的所有函数。</p>
<h3 id="事件循环机制"><a href="#事件循环机制" class="headerlink" title="事件循环机制"></a>事件循环机制</h3><p>实现 <code>Promise</code> 涉及到了 <code>JavaScript</code> 中的事件循环机制 <code>EventLoop</code>、以及宏任务和微任务的概念。</p>
<p>事件循环机制的流程图如下：</p>
<p><img src="https://camo.githubusercontent.com/e25d50e7473d8a8d90bd58b8e3b09c1ec301fd9b9ea25488c9c08e988ba5747a/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f36316566626332302d376362382d313165622d383566362d3666616337376330633962332e706e67" alt="img"></p>
<p>大家可以看一下这段代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果不能一下子说出输出结果，建议大家可以先查阅一下 <strong>事件循环</strong> 的相关资料。</p>
<h3 id="Promises-A-规范"><a href="#Promises-A-规范" class="headerlink" title="Promises/A+ 规范"></a>Promises/A+ 规范</h3><p><a href="https://link.juejin.cn/?target=https://promisesaplus.com/">Promises/A+</a> 是一个社区规范，如果你想写出一个规范的 <code>Promise</code>，我们就需要遵循这个标准。之后我们也会根据规范来完善我们自己编写的 <code>Promise</code>。</p>
<h2 id="Promise-核心知识点"><a href="#Promise-核心知识点" class="headerlink" title="Promise 核心知识点"></a>Promise 核心知识点</h2><p>在动手写 <code>Promise</code> 之前，我们先过一下几个重要的知识点。</p>
<h3 id="executor"><a href="#executor" class="headerlink" title="executor"></a>executor</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 创建 Promise 对象 x1</span>
<span class="token comment">// 并在 executor 函数中执行业务逻辑</span>
<span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 业务逻辑处理成功结果</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 失败结果</span>
  <span class="token comment">// const reason = ...;</span>
  <span class="token comment">// reject(reason);</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> x1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先 <code>Promise</code> 是一个类，它接收一个执行函数 <code>executor</code>，它接收两个参数：<code>resolve</code> 和 <code>reject</code>，这两个参数是 <code>Promise</code> 内部定义的两个函数，用来改变状态并执行对应回调函数。</p>
<blockquote>
<p>因为 <code>Promise</code> 本身是不知道执行结果失败或者成功，它只是给异步操作提供了一个容器，实际上的控制权在使用者的手上，使用者可以调用上面两个参数告诉 <code>Promise</code> 结果是否成功，同时将业务逻辑处理结果（<code>value/reason</code>）作为参数传给 <code>resolve</code> 和 <code>reject</code> 两个函数，执行回调。</p>
</blockquote>
<h3 id="三个状态"><a href="#三个状态" class="headerlink" title="三个状态"></a>三个状态</h3><p><code>Promise</code> 有三个状态：</p>
<ul>
<li><code>pending</code>：等待中</li>
<li><code>resolved</code>：已成功</li>
<li><code>rejected</code>：已失败</li>
</ul>
<p>在 <code>Promise</code> 的状态改变只有两种可能：从 <code>pending</code> 变为 <code>resolved</code> 或者从 <code>pending</code> 变为 <code>rejected</code>，如下图（引自 Promise 迷你书）：</p>
<p><img src="data:image/png;base64,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" alt="引自 Promise 迷你书"></p>
<p>而且需要注意的是一旦状态改变，状态不会再变了，接下来就一直是这个结果。也就是说当我们在 <code>executor</code> 函数中调用了 <code>resolve</code> 之后，之后调用 <code>reject</code> 就没有效果了，反之亦然。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 并在 executor 函数中执行业务逻辑</span>
<span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 之后调用 resolve，reject 都是无效的，</span>
  <span class="token comment">// 因为状态已经变为 resolved，不会再改变了</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> x1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="then"><a href="#then" class="headerlink" title="then"></a>then</h3><p>每一个 <code>promise</code> 都一个 <code>then</code> 方法，这个是当 <code>promise</code> 返回结果之后，需要执行的回调函数，他有两个可选参数：</p>
<ul>
<li><code>onFulfilled</code>：成功的回调；</li>
<li><code>onRejected</code>：失败的回调；</li>
</ul>
<p>如下图（引自 Promise 迷你书）：</p>
<p><img src="data:image/png;base64,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" alt="引自 Promise 迷你书"></p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// ...</span>
<span class="token keyword">let</span> x1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// x1 延迟绑定回调函数 onResolve</span>
<span class="token keyword">function</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// x1 延迟绑定回调函数 onRejected</span>
<span class="token keyword">function</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

x1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="手写-Promise-大致流程"><a href="#手写-Promise-大致流程" class="headerlink" title="手写 Promise 大致流程"></a>手写 Promise 大致流程</h2><p>在这里我们简单过一下手写一个 <code>Promise</code> 的大致流程：</p>
<h3 id="executor-与三个状态"><a href="#executor-与三个状态" class="headerlink" title="executor 与三个状态"></a>executor 与三个状态</h3><ul>
<li><code>new Promise</code> 时，需要传递一个 <code>executor</code> 执行器函数，在构造函数中，<strong>执行器函数立刻执行</strong></li>
<li><code>executor</code> 执行函数接受两个参数，分别是 <code>resolve</code> 和 <code>reject</code></li>
<li><code>Promise</code> 只能从 <code>pending</code> 到 <code>rejected</code>, 或者从 <code>pending</code> 到 <code>fulfilled</code></li>
<li><code>Promise</code> 的状态一旦确认，状态就凝固了，不在改变</li>
</ul>
<h3 id="then-方法"><a href="#then-方法" class="headerlink" title="then 方法"></a>then 方法</h3><ul>
<li>所有的 <code>Promise</code> 都有 <code>then</code> 方法，<code>then</code> 接收两个参数，分别是 <code>Promise</code> 成功的回调 <code>onFulfilled</code>，和失败的回调 <code>onRejected</code></li>
<li>如果调用 <code>then</code> 时，<code>Promise</code> 已经成功，则执行 <code>onFulfilled</code>，并将 <code>Promise</code> 的值作为参数传递进去；如果 <code>Promise</code> 已经失败，那么执行 <code>onRejected</code>，并将 <code>Promise</code> 失败的原因作为参数传递进去；如果 <code>Promise</code> 的状态是 <code>pending</code>，需要将 <code>onFulfilled</code> 和 <code>onRejected</code> 函数存放起来，等待状态确定后，再依次将对应的函数执行(观察者模式)</li>
<li><code>then</code> 的参数 <code>onFulfilled</code> 和 <code>onRejected</code> 可以不传，<code>Promise</code> <strong>可以进行值穿透</strong>。</li>
</ul>
<h3 id="链式调用并处理-then-返回值"><a href="#链式调用并处理-then-返回值" class="headerlink" title="链式调用并处理 then 返回值"></a>链式调用并处理 then 返回值</h3><ul>
<li><code>Promise</code> 可以 <code>then</code> 多次，<code>Promise</code> 的 <code>then</code> 方法返回一个新的 <code>Promise</code>。</li>
<li>如果 <code>then</code> 返回的是一个正常值，那么就会把这个结果（<code>value</code>）作为参数，传递给下一个 <code>then</code> 的成功的回调（<code>onFulfilled</code>）</li>
<li>如果 <code>then</code> 中抛出了异常，那么就会把这个异常（<code>reason</code>）作为参数，传递给下一个 <code>then</code> 的失败的回调(<code>onRejected</code>)</li>
<li>如果 <code>then</code> 返回的是一个 <code>promise</code> 或者其他 <code>thenable</code> 对象，那么需要等这个 <code>promise</code> 执行完撑，<code>promise</code> 如果成功，就走下一个 <code>then</code> 的成功回调；如果失败，就走下一个 <code>then</code> 的失败回调。</li>
</ul>
<h2 id="第一版（从一个简单例子开始）"><a href="#第一版（从一个简单例子开始）" class="headerlink" title="第一版（从一个简单例子开始）"></a>第一版（从一个简单例子开始）</h2><blockquote>
<p>我们先写一个简单版，这版暂不支持状态、链式调用，并且只支持调用一个 <code>then</code> 方法。</p>
</blockquote>
<h3 id="来个-🌰"><a href="#来个-🌰" class="headerlink" title="来个 🌰"></a>来个 🌰</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'成功了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>例子很简单，就是 <code>1s</code> 之后返回 <code>成功了</code>，并在 <code>then</code> 中输出。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>我们定义一个 <code>MyPromise</code> 类，接着我们在其中编写代码，具体代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ts 接口定义 ...</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">executor<span class="token operator">:</span> executor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 用于保存 resolve 的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于保存 reject 的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于保存 then 的成功回调</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于保存 then 的失败回调</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// executor 的 resolve 参数</span>
    <span class="token comment">// 用于改变状态 并执行 then 中的成功回调</span>
    <span class="token keyword">let</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// executor 的 reject 参数</span>
    <span class="token comment">// 用于改变状态 并执行 then 中的失败回调</span>
    <span class="token keyword">let</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 执行 executor 函数</span>
    <span class="token comment">// 将我们上面定义的两个函数作为参数 传入</span>
    <span class="token comment">// 有可能在 执行 executor 函数的时候会出错，所以需要 try catch 一下 </span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 定义 then 函数</span>
  <span class="token comment">// 并且将 then 中的参数复制给 this.onFulfilled 和 this.onRejected</span>
  <span class="token keyword">private</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> onFulfilled<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">=</span> onRejected<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>好了，我们的第一版就完成了，是不是很简单。</p>
<blockquote>
<p>不过这里需要注意的是，<code>resolve</code> 函数的执行时机需要在 <code>then</code> 方法将回调函数注册了之后，在 <code>resolve</code> 之后在去往赋值回调函数，其实已经完了，没有任何意义。</p>
<p>上面的例子没有问题，是因为 <code>resolve(成功了)</code> 是包在 <code>setTimeout</code> 中的，他会在下一个宏任务执行，这时回调函数已经注册了。</p>
<p>大家可以试试把 <code>resolve(成功了)</code> 从 <code>setTimeout</code> 中拿出来，这个时候就会出现问题了。</p>
</blockquote>
<h3 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h3><p>这一版实现很简单，还存在几个问题：</p>
<ul>
<li>未引入状态的概念</li>
</ul>
<p>未引入状态的概念，现在状态可以随意变，不符合 <code>Promise</code> 状态只能从等待态变化的规则。</p>
<ul>
<li>不支持链式调用</li>
</ul>
<p>正常情况下我们可以对 <code>Promise</code> 进行链式调用：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'成功了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolved1<span class="token punctuation">,</span> onRejected1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolved2<span class="token punctuation">,</span> onRejected2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>只支持一个回调函数，如果存在多个回调函数的话，后面的会覆盖前面的</li>
</ul>
<p>在这个例子中，<code>onResolved2</code> 会覆盖 <code>onResolved1</code>，<code>onRejected2</code> 会覆盖 <code>onRejected1</code>。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'成功了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 注册多个回调函数</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolved1<span class="token punctuation">,</span> onRejected1<span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolved2<span class="token punctuation">,</span> onRejected2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第二版（实现链式调用）"><a href="#第二版（实现链式调用）" class="headerlink" title="第二版（实现链式调用）"></a>第二版（实现链式调用）</h2><blockquote>
<p>这一版我们把状态的概念引入，同时实现链式调用的功能。</p>
</blockquote>
<h3 id="加上状态"><a href="#加上状态" class="headerlink" title="加上状态"></a>加上状态</h3><p>上面我们说到 <code>Promise</code> 有三个状态：<code>pending</code>、<code>resovled</code>、<code>rejected</code>，只能从 <code>pending</code> 转为 <code>resovled</code> 或者 <code>rejected</code>，而且当状态改变之后，状态就不能再改变了。</p>
<ul>
<li>我们定义一个属性 <code>status</code>：用于记录当前 <code>Promise</code> 的状态</li>
<li>为了防止写错，我们把状态定义成常量 <code>PENDING</code>、<code>RESOLVED</code>、<code>REJECTED</code>。</li>
<li>同时我们将保存 <code>then</code> 的成功回调定义为一个数组：<code>this.resolvedQueues</code> 与 <code>this.rejectedQueues</code>，我们可以把 <code>then</code> 中的回调函数都塞入对应的数组中，这样就能解决我们上面提到的第三个问题。</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">RESOLVED</span> <span class="token operator">=</span> <span class="token string">'resolved'</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">executor<span class="token operator">:</span> executor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 用于保存 then 的成功回调数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedQueues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于保存 then 的失败回调数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedQueues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 当状态是 pending 是，将 promise 的状态改为成功态</span>
      <span class="token comment">// 同时遍历执行 成功回调数组中的函数，将 value 传入</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token constant">RESOLVED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedQueues<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=></span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 当状态是 pending 是，将 promise 的状态改为失败态</span>
      <span class="token comment">// 同时遍历执行 失败回调数组中的函数，将 reason 传入</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedQueues<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=></span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="完善-then-函数"><a href="#完善-then-函数" class="headerlink" title="完善 then 函数"></a>完善 then 函数</h3><p>接着我们来完善 <code>then</code> 中的方法，之前我们是直接将 <code>then</code> 的两个参数 <code>onFulfilled</code> 和 <code>onRejected</code>，直接赋值给了 <code>Promise</code> 的用于保存成功、失败函数回调的实例属性。</p>
<p>现在我们需要将这两个属性塞入到两个数组中去：<code>resolvedQueues</code> 和 <code>rejectedQueues</code>。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">private</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 首先判断两个参数是否为函数类型，因为这两个参数是可选参数</span>
    <span class="token comment">// 当参数不是函数类型时，需要创建一个函数赋值给对应的参数</span>
    <span class="token comment">// 这也就实现了 透传</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=></span> value<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> reason<span class="token punctuation">&#125;</span>

    <span class="token comment">// 当状态是等待态的时候，需要将两个参数塞入到对应的回调数组中</span>
    <span class="token comment">// 当状态改变之后，在执行回调函数中的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 状态是成功态，直接就调用 onFulfilled 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 状态是成功态，直接就调用 onRejected 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="then-函数的一些说明"><a href="#then-函数的一些说明" class="headerlink" title="then 函数的一些说明"></a>then 函数的一些说明</h4><ul>
<li>什么情况下 <code>this.status</code> 会是 <code>pending</code> 状态，什么情况下会是 <code>resolved</code> 状态</li>
</ul>
<p>这个其实也和事件循环机制有关，如下代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// this.status 为 pending 状态</span>
<span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// this.status 为 resolved 状态</span>
<span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>什么是 <strong>透传</strong></li>
</ul>
<p>如下面代码，当 <code>then</code> 中没有传任何参数的时候，<code>Promise</code> 会使用内部默认的定义的方法，将结果传递给下一个 <code>then</code>。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'成功了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为我们现在还没支持链式调用，这段代码运行会出问题。</p>
<h4 id="支持链式调用"><a href="#支持链式调用" class="headerlink" title="支持链式调用"></a>支持链式调用</h4><p>支持链式调用，其实很简单，我们只需要给 <code>then</code> 函数最后返回 <code>this</code> 就行，这样就支持了链式调用：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">private</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每次调用 <code>then</code> 之后，我们都返回当前的这个 <code>Promise</code> 对象，因为 <code>Promise</code> 对象上是存在 <code>then</code> 方法的，这个时候我们就简单的实现了 <code>Promise</code> 的简单调用。</p>
<p>这个时候运行上面 <strong>透传</strong> 的测试代码了。</p>
<p>但是上面的代码还是存在相应的问题的，看下面代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'then1'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'then2'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'then3'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 预测输出：resolved -> then1 -> then2</span>
<span class="token comment">// 实际输出：resolved -> resolved -> resolved</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出与我们的预期有偏差，因为我们 <code>then</code> 中返回的 <code>this</code> 代表了 <code>p1</code>，在 <code>new MyPromise</code> 之后，其实状态已经从 <code>pending</code> 态变为了 <code>resolved</code> 态，之后不会再变了，所以在 <code>MyPromise</code> 中的 <code>this.value</code> 值就一直是 <code>resolved</code>。</p>
<p>这个时候我们就得看看关于 <code>then</code> 返回值的相关知识点了。</p>
<h4 id="then-返回值"><a href="#then-返回值" class="headerlink" title="then 返回值"></a>then 返回值</h4><p>实际上 <code>then</code> 都会返回了一个新的 <code>Promise</code> 对象。</p>
<p>先看下面这段代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 新创建一个 promise</span>
<span class="token keyword">const</span> aPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// then 返回的 promise</span>
<span class="token keyword">var</span> thenPromise <span class="token operator">=</span> aPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aPromise <span class="token operator">!==</span> thenPromise<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// => true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从上面的代码中我们可以得出 <code>then</code> 方法返回的 <code>Promise</code> 已经不再是最初的 <code>Promise</code> 了，如下图（引自 Promise 迷你书）：</p>
<p><img src="https://lh3.googleusercontent.com/proxy/lr0YKuQsKF2WSNXRArldIbv4tf6Gvleo-lnhF-IsNpzkHlefyjdou7u4cvcobhjmk2Up6BM75C5BK9H0yIOhDmSedgL9-iUBoHyuIcJzPLry5lEBwUtFlKE" alt="引自 Promise 迷你书"></p>
<blockquote>
<p><code>promise</code> 的链式调用跟 <code>jQuery</code> 的链式调用是有区别的，<code>jQuery</code> 链式调用返回的对象还是最初那个 <code>jQuery</code> 对象；<code>Promise</code> 更类似于数组中一些方法，如 <code>slice</code>，每次进行操作之后，都会返回一个新的值。</p>
</blockquote>
<h4 id="改造代码"><a href="#改造代码" class="headerlink" title="改造代码"></a>改造代码</h4><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">private</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=></span> value<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> reason<span class="token punctuation">&#125;</span>

    <span class="token comment">// then 方法返回一个新的 promise</span>
    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 成功状态，直接 resolve</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将 onFulfilled 函数的返回值，resolve 出去</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 失败状态，直接 reject</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将 onRejected 函数的返回值，reject 出去</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
        reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 等待状态，将 onFulfilled，onRejected 塞入数组中，等待回调执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
          reject <span class="token operator">&amp;&amp;</span> <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise2<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 输出结果 resolved -> then1 -> then2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="存在问题-1"><a href="#存在问题-1" class="headerlink" title="存在问题"></a>存在问题</h3><p>到这里我们就完成了简单的链式调用，但是只能支持同步的链式调用，如果我们需要在 <code>then</code> 方法中再去进行其他异步操作的话，上面的代码就 GG 了。</p>
<p>如下代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'我 resolved 了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'then3'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码会直接将 <code>Promise</code> 对象直接当作参数传给下一个 <code>then</code> 函数，而我们其实是想要将这个 <code>Promise</code> 的处理结果传递下去。</p>
<h2 id="第三版（异步链式调用）"><a href="#第三版（异步链式调用）" class="headerlink" title="第三版（异步链式调用）"></a>第三版（异步链式调用）</h2><blockquote>
<p>这一版我们来实现 <code>promise</code> 的异步链式调用。</p>
</blockquote>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>先看一下 <code>then</code> 中 <code>onFulfilled</code> 和 <code>onRejected</code> 返回的值：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 成功的函数返回</span>
<span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 失败的函数返回</span>
<span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从上面的的问题中可以看出，<code>x</code> 可以是一个 <strong>普通值</strong>，也可以是一个 <strong><code>Promise</code></strong> 对象，普通值的传递我们在 <strong>第二版</strong> 已经解决了，现在需要解决的是当 <code>x</code> 返回一个 <code>Promise</code> 对象的时候该怎么处理。</p>
<p>其实也很简单，当 <code>x</code> 是一个 <code>Promise</code> 对象的时候，我们需要进行等待，直到返回的 <code>Promise</code> 状态变化的时候，再去执行之后的 <code>then</code> 函数，代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">private</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=></span> value<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> reason<span class="token punctuation">&#125;</span>

    <span class="token comment">// then 方法返回一个新的 promise</span>
    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 成功状态，直接 resolve</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将 onFulfilled 函数的返回值，resolve 出去</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 失败状态，直接 reject</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将 onRejected 函数的返回值，reject 出去</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 等待状态，将 onFulfilled，onRejected 塞入数组中，等待回调执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise2<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们新写一个函数 <code>resolvePromise</code>，这个函数是用来处理异步链式调用的核心方法，他会去判断 <code>x</code> 返回值是不是 <code>Promise</code> 对象，如果是的话，就直到 <code>Promise</code> 返回成功之后在再改变状态，如果是普通值的话，就直接将这个值 <code>resovle</code> 出去：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">resolvePromise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">==</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token parameter">y</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h3><h4 id="resolvePromise"><a href="#resolvePromise" class="headerlink" title="resolvePromise"></a>resolvePromise</h4><p><code>resolvePromise</code> 接受四个参数：</p>
<ul>
<li><code>promise2</code> 是 <code>then</code> 中返回的 <code>promise</code>；</li>
<li><code>x</code> 是 <code>then</code> 的两个参数 <code>onFulfilled</code> 或者 <code>onRejected</code> 的返回值，类型不确定，有可能是普通值，有可能是 <code>thenable</code> 对象；</li>
<li><code>resolve</code> 和 <code>reject</code> 是 <code>promise2</code> 的。</li>
</ul>
<h4 id="then-返回值类型"><a href="#then-返回值类型" class="headerlink" title="then 返回值类型"></a>then 返回值类型</h4><p>当 <code>x</code> 是 <code>Promise</code> 的时，并且他的状态是 <code>Pending</code> 状态，如果 <code>x</code> 执行成功，那么就去递归调用 <code>resolvePromise</code> 这个函数，将 <code>x</code> 执行结果作为 <code>resolvePromise</code> 第二个参数传入；</p>
<p>如果执行失败，则直接调用 <code>promise2</code> 的 <code>reject</code> 方法。</p>
<p>到这里我们基本上一个完整的 <code>promise</code>，接下来我们需要根据 <a href="https://link.juejin.cn/?target=https://promisesaplus.com/">Promises/A+</a> 来规范一下我们的 <code>Promise</code>。</p>
<h2 id="规范-Promise"><a href="#规范-Promise" class="headerlink" title="规范 Promise"></a>规范 Promise</h2><p>前几版的代码笔者基本上是按照规范来的，这里主要讲几个没有符合规范的点。</p>
<h3 id="规范-then（规范-2-2）"><a href="#规范-then（规范-2-2）" class="headerlink" title="规范 then（规范 2.2）"></a>规范 then（规范 2.2）</h3><blockquote>
<p><code>then</code> 中 <code>onFulfilled</code> 和 <code>onRejected</code> 需要异步执行，即放到异步任务中去执行（规范 2.2.4）</p>
</blockquote>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>我们需要将 <code>then</code> 中的函数通过 <code>setTimeout</code> 包裹起来，放到一个宏任务中去，这里涉及了 <code>js</code> 的 <code>EventLoop</code>，大家可以去看看相应的文章，如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">private</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// then 方法返回一个新的 promise</span>
    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 成功状态，直接 resolve</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将 onFulfilled 函数的返回值，resolve 出去</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 失败状态，直接 reject</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将 onRejected 函数的返回值，reject 出去</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 等待状态，将 onFulfilled，onRejected 塞入数组中，等待回调执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolvedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise2<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="使用微任务包裹"><a href="#使用微任务包裹" class="headerlink" title="使用微任务包裹"></a>使用微任务包裹</h4><p>但这样还是有一个问题，我们知道其实 <code>Promise.then</code> 是属于微任务的，现在当使用 <code>setTimeout</code> 包裹之后，就相当于会变成一个宏任务，可以看下面这一个例子：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---setTimeout---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---then---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 正常 Promise：then -> setTimeout</span>
<span class="token comment">// 我们的 Promise：setTimeout -> then</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出顺序不一样，原因是因为现在的 <code>Promise</code> 是通过 <code>setTimeout</code> 宏任务包裹的。</p>
<p>我们可以改进一下，使用微任务来包裹 <code>onFulfilled</code> 、<code>onRejected</code>，常用的微任务有 <code>process.nextTick</code>、<code>MutationObserver</code>、<code>postMessage</code> 等，我们这个使用 <code>postMessage</code> 改写一下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 将 onFulfilled 函数的返回值，resolve 出去</span>
  <span class="token comment">// 注册一个 message 事件</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> type<span class="token punctuation">,</span> data <span class="token punctuation">&#125;</span> <span class="token operator">=</span>  event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'__promise'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 立马执行</span>
  window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">'__promise'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:3001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实现方法很简单，我们监听<code>window</code> 的 <code>message</code> 事件，并在之后立马触发一个 <code>postMessage</code> 事件，这个时候其实 <code>then</code> 中的回调函数已经在微任务队列中了，我们重新运行一下例子，可以看到输出的顺序变为了 <code>then -&gt; setTimeout</code>。</p>
<blockquote>
<p>当然 <code>Promise</code> 内部实现肯定没有这么简单，笔者在这里只是提供一种思路，大家有兴趣可以去研究一波。</p>
</blockquote>
<h3 id="规范-resolvePromise-函数（规范-2-3）"><a href="#规范-resolvePromise-函数（规范-2-3）" class="headerlink" title="规范 resolvePromise 函数（规范 2.3）"></a>规范 resolvePromise 函数（规范 2.3）</h3><h4 id="重复引用"><a href="#重复引用" class="headerlink" title="重复引用"></a>重复引用</h4><blockquote>
<p>重复引用，当 <code>x</code> 和 <code>promise2</code> 是一样的，那就需要报一个错误，重复应用。（规范 2.3.1）</p>
<p><strong>因为自己等待自己完成是永远都不会有结果的。</strong></p>
</blockquote>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'我 resolved 了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> p2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/4/171dee30c47e8637~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<h4 id="x-的类型"><a href="#x-的类型" class="headerlink" title="x 的类型"></a>x 的类型</h4><p>大致分为一下这么几条：</p>
<ul>
<li>2.3.2：当 <code>x</code> 是一个 <code>Promise</code>，那么就等待 <code>x</code> 改变状态之后，才算完成或者失败（这个也属于 <code>2.3.3</code>，因为 <code>Promise</code> 其实也是一个 <code>thenable</code> 对象）</li>
<li>2.3.3：当 <code>x</code> 是一个对象 或者 函数的时候，即 <code>thenable</code> 对象，那就那 <code>x.then</code> 作为 <code>then</code></li>
<li>2.3.4：当 <code>x</code> 不是一个对象，或者函数的时候，直接将 <code>x</code> 作为参数 <code>resolve</code> 返回。</li>
</ul>
<p>我们主要看一下 <code>2.3.3</code> 就行，因为 <code>Prmise</code> 也属于 <code>thenable</code> 对象，那什么是 <code>thenable</code> 对象呢？</p>
<blockquote>
<p>简单来说就是具有 <strong>then</strong>方法的对象/函数，所有的 <code>Promise</code> 对象都是 <code>thenable</code> 对象，但并非所有的 <code>thenable</code> 对象并非是 <code>Promise</code> 对象。如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
 <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>根据 <code>x</code> 的类型进行处理：</p>
<ul>
<li>如果 <code>x</code> 不是 <code>thenable</code> 对象，直接调用 <code>Promise2</code> 的 <code>resolve</code>，将 <code>x</code> 作为成功的结果；</li>
<li>当 <code>x</code> 是 <code>thenable</code> 对象，会调用 <code>x</code> 的 <code>then</code> 方法，成功后再去调用 <code>resolvePromise</code> 函数，并将执行结果 <code>y</code> 作为新的 <code>x</code> 传入 <code>resolvePromise</code>，直到这个 <code>x</code> 值不再是一个 <code>thenable</code> 对象为止；如果失败则直接调用 <code>promise2</code> 的 <code>reject</code>。</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="只调用一次"><a href="#只调用一次" class="headerlink" title="只调用一次"></a>只调用一次</h4><blockquote>
<p>规范（<code>Promise/A+ 2.3.3.3.3</code>）规定如果同时调用 <code>resolvePromise</code> 和 <code>rejectPromise</code>，或者对同一参数进行了多次调用，则第一个调用优先，而所有其他调用均被忽略，确保只执行一次改变状态。</p>
</blockquote>
<p>我们在外面定义了一个 <code>called</code> 占位符，为了获得 <code>then</code> 函数有没有执行过相应的改变状态的函数，执行过了之后，就不再去执行了，主要就是为了满足规范。</p>
<h5 id="x-为-Promise-对象"><a href="#x-为-Promise-对象" class="headerlink" title="x 为 Promise 对象"></a>x 为 Promise 对象</h5><p>如果 <code>x</code> 是 <code>Promise</code> 对象的话，其实当执行了<code>resolve</code> 函数 之后，就不会再执行 <code>reject</code> 函数了，是直接在当前这个 <code>Promise</code> 对象就结束掉了。</p>
<h5 id="x-为-thenable-对象"><a href="#x-为-thenable-对象" class="headerlink" title="x 为 thenable 对象"></a>x 为 thenable 对象</h5><p>当 <code>x</code> 是普通的 <code>thenable</code> 函数的时候，他就有可能同时执行 <code>resolve</code> 和 <code>reject</code> 函数，即可以同时执行 <code>promise2</code> 的 <code>resolve</code> 函数 和 <code>reject</code> 函数，但是其实 <code>promise2</code> 在状态改变了之后，也不会再改变相应的值了。其实也没有什么问题，如下代码：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// thenable 对像</span>
<span class="token punctuation">&#123;</span>
 <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
     <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'我是thenable对像的 resolve'</span><span class="token punctuation">)</span>；
     <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'我是thenable对像的 reject'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="完整的-resolvePromise"><a href="#完整的-resolvePromise" class="headerlink" title="完整的 resolvePromise"></a>完整的 resolvePromise</h4><p>完整的 <code>resolvePromise</code> 函数如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">resolvePromise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">===</span> promise2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">let</span> called<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token parameter">y</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后我们可以通过测试脚本跑一下我们的 <code>MyPromise</code> 是否符合规范。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>有专门的测试脚本（<code>promises-aplus-tests</code>）可以帮助我们测试所编写的代码是否符合 <code>Promise/A+</code> 的规范。</p>
<blockquote>
<p>但是貌似只能测试 <code>js</code> 文件，所以笔者就将 <code>ts</code> 文件转化为了 <code>js</code> 文件，进行测试</p>
</blockquote>
<p>在代码里面加上：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 执行测试用例需要用到的代码</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
      defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要提前安装一下测试插件：</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 安装测试脚本
npm i -g promises-aplus-tests

# 开始测试
promises-aplus-tests MyPromise.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果如下：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/4/171dee469816c2f6~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>完美通过，接下去我们就可以看看 <code>Promise</code> 更多方法的实现了。</p>
<h2 id="更多方法"><a href="#更多方法" class="headerlink" title="更多方法"></a>更多方法</h2><p>实现上面的 <code>Promise</code> 之后，其实编写其实例和静态方法，相对来说就简单了很多。</p>
<h3 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h3><h4 id="Promise-prototype-catch"><a href="#Promise-prototype-catch" class="headerlink" title="Promise.prototype.catch"></a>Promise.prototype.catch</h4><h5 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h5><p>其实这个方法就是 <code>then</code> 方法的语法糖，只需要给 <code>then</code> 传递 <code>onRejected</code> 参数就 <code>ok</code> 了。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">private</span> <span class="token function">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token string">'错误了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string">'then3'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 1s 之后输出：----error 错误了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Promise-prototype-finally"><a href="#Promise-prototype-finally" class="headerlink" title="Promise.prototype.finally"></a>Promise.prototype.finally</h4><h5 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h5><p><code>finally()</code> 方法用于指定不管 <code>Promise</code> 对象最后状态如何，都会执行的操作。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">private</span> <span class="token function">finally</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token string">'错误了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolved</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string">'then3'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">catch-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---finally---'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 输出结果：---error 错误了" -> ""---finally--- catch-错误了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><h4 id="Promise-resolve"><a href="#Promise-resolve" class="headerlink" title="Promise.resolve"></a>Promise.resolve</h4><h5 id="实现-4"><a href="#实现-4" class="headerlink" title="实现"></a>实现</h5><p>有时需要将现有对象转为 <code>Promise</code> 对象，<code>Promise.resolve()</code>方法就起到这个作用。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">static</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js">MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name<span class="token operator">:</span> <span class="token string">'darrell'</span><span class="token punctuation">,</span> sex<span class="token operator">:</span> <span class="token string">'boy'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出结果：&#123;name: "darrell", sex: "boy"&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Promise-reject"><a href="#Promise-reject" class="headerlink" title="Promise.reject"></a>Promise.reject</h4><h5 id="实现-5"><a href="#实现-5" class="headerlink" title="实现"></a>实现</h5><p><code>Promise.reject(reason)</code> 方法也会返回一个新的 <code>Promise</code> 实例，该实例的状态为 <code>rejected</code>。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">static</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js">MyPromise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">"出错了"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出结果：出错了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all"></a>Promise.all</h4><p><code>Promise.all()</code>方法用于将多个 <code>Promise</code> 实例，包装成一个新的 <code>Promise</code> 实例，</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>只有 <code>p1</code>、<code>p2</code>、<code>p3</code> 的状态都变成 <code>fulfilled</code>，<code>p</code> 的状态才会变成 <code>fulfilled</code>；</li>
<li>只要 <code>p1</code>、<code>p2</code>、<code>p3</code> 之中有一个被 <code>rejected</code>，<code>p</code> 的状态就变成 <code>rejected</code>，此时第一个被 <code>reject</code> 的实例的返回值，会传递给<code>p</code>的回调函数。</li>
</ul>
<h5 id="实现-6"><a href="#实现-6" class="headerlink" title="实现"></a>实现</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">static</span> <span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promises<span class="token operator">:</span> MyPromise<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> result<span class="token operator">:</span> MyPromise<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> Promise1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> Promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> Promise3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Promise3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> Promise4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Promise4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Promise1<span class="token punctuation">,</span> Promise2<span class="token punctuation">,</span> Promise3<span class="token punctuation">,</span> Promise4<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 三个都成功则成功  </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---成功了'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 只要有失败，则失败 </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---失败了'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 直接输出：---失败了 Promise4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race"></a>Promise.race</h4><p><code>Promise.race()</code>方法同样是将多个 Promise 实例，包装成一个新的 Promise 实例。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>只要 <code>p1</code>、<code>p2</code>、<code>p3</code> 之中有一个实例率先改变状态，<code>p</code> 的状态就跟着改变。那个率先改变的 <code>Promise</code> 实例的返回值，就传递给 <code>p</code> 的回调函数。</p>
<h5 id="实现-7"><a href="#实现-7" class="headerlink" title="实现"></a>实现</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">static</span> <span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="例子-4"><a href="#例子-4" class="headerlink" title="例子"></a>例子</h5><p>例子和 <code>all</code> 一样，调用如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// ...</span>

<span class="token keyword">let</span> p <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Promise1<span class="token punctuation">,</span> Promise2<span class="token punctuation">,</span> Promise3<span class="token punctuation">,</span> Promise4<span class="token punctuation">]</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---成功了'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---失败了'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 直接输出：---成功了 Promise2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Promise-allSettled"><a href="#Promise-allSettled" class="headerlink" title="Promise.allSettled"></a>Promise.allSettled</h4><p>此方法接受一组 <code>Promise</code> 实例作为参数，包装成一个新的 <code>Promise</code> 实例。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>只有等到所有这些参数实例都返回结果，不管是 <code>fulfilled</code> 还是 <code>rejected</code>，而且该方法的状态只可能变成 <code>fulfilled</code>。</p>
<blockquote>
<p>此方法与 <code>Promise.all</code> 的区别是 <code>all</code> 无法确定所有请求都结束，因为在 <code>all</code> 中，如果有一个被 <code>Promise</code> 被 <code>rejected</code>，<code>p</code> 的状态就立马变成 <code>rejected</code>，有可能有些异步请求还没走完。</p>
</blockquote>
<h5 id="实现-8"><a href="#实现-8" class="headerlink" title="实现"></a>实现</h5><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">static</span> <span class="token function-variable function">allSettled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promises<span class="token operator">:</span> MyPromise<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> result<span class="token operator">:</span> MyPromise<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="例子-5"><a href="#例子-5" class="headerlink" title="例子"></a>例子</h5><p>例子和 <code>all</code> 一样，调用如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> p <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token function">allSettled</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Promise1<span class="token punctuation">,</span> Promise2<span class="token punctuation">,</span> Promise3<span class="token punctuation">,</span> Promise4<span class="token punctuation">]</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 三个都成功则成功  </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---成功了'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 只要有失败，则失败 </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---失败了'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 2s 后输出：---成功了 (4) ["Promise1", "Promise2", "Promise3", "Promise4"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
        <a target="_blank" class="social-link" href="https://twitter.com/zheyizhifeng">
          <span class="icon">
            <i class="fab fa-twitter"></i>
          </span>

          <span class="label">Twitter</span>
        </a>
      </div>

      <div class="social-item">
        <a target="_blank" class="social-link" href="https://t.me/zheyizhifeng">
          <span class="icon">
            <i class="fab fa-telegram"></i>
          </span>

          <span class="label">Telegram</span>
        </a>
      </div>

      <div class="social-item">
        <a target="_blank" class="social-link" href="/images/wechat.jpg">
          <span class="icon">
            <i class="fab fa-weixin"></i>
          </span>

          <span class="label">WeChat</span>
        </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/JavaScript/" rel="tag"><i class="fa fa-tag"></i> JavaScript</a>
              <a href="/tags/Programming/" rel="tag"><i class="fa fa-tag"></i> Programming</a>
              <a href="/tags/ES-6/" rel="tag"><i class="fa fa-tag"></i> ES 6</a>
              <a href="/tags/Promise/" rel="tag"><i class="fa fa-tag"></i> Promise</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/10/13/JS%20%E7%9A%84%20try%20catch%20%E8%83%BD%E6%8D%95%E8%8E%B7%E5%88%B0%E5%93%AA%E4%BA%9B%E5%BC%82%E5%B8%B8/" rel="prev" title="JS 的 try catch 能捕获到哪些异常">
                  <i class="fa fa-chevron-left"></i> JS 的 try catch 能捕获到哪些异常
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/10/13/%E4%BA%8C%E7%BB%B4%E7%A0%81%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E6%98%AF%E4%BB%80%E4%B9%88%E5%8E%9F%E7%90%86/" rel="next" title="二维码扫码登录是什么原理">
                  二维码扫码登录是什么原理 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lucida</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
